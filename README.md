# DevOps
### DevOps Example: Using Now.sh, CircleCI, Docker, Packager.io and Terraforming

The application in node.js is in the files: app.js, server.js and test in test/test.js

The declaration of the infrastructure in Terraforming is in infra/main.tf

The file to create snapshots is in deployments/template.json

The scripts for deployment are in deployments/

### Running scripts

To run server

```
node server.js
```

To run test
```
npm run test
```
To build Docker container
```
docker build -t platzi .
```
To run docker container
```
docker run -p 3000:3000 platzi
```
To run test in docker container
```
docker run platzi npm test
```
Note: Every time we push the repository automatically, circleCI starts a pipeline.

To install Now.sh
```
npm install -g now
```
To register new user in Now.sh
```
now -L
```
To run our dockerfile in now.sh
```
now --docker
```
To link now.sh with circleCI go to account settings and generate a tocken, then go to circleCI, go to the configuration of the project and in enviroment variables add the tocken generated by now.sh

```
NOW_TOCKEN
onfWbiLeCEkArSHKeDMrfCIE
```
Now to create a new branch we use the command
```
git checkout -b 'feature_html_change'
```
To create images we can use packer.io, we create the template.json file, to create the spanshot we use:
```
packer build template.json
```
This command returns an id of the created snapshot

To work with the infrastructure we use Terraform, to see the resources that will be created we use:
```
terraform plan
```
Then to create the resources we use
```
terraform apply
```
To create snapshots we use circleCI environment variables, in this case we will use CIRCLE_BUILD_NUMBER

For our deploy and that packer can talk with digitalOCean in circleCI, we create a token in digitalocean and what
we use in circleCI

```
DIGITALOCEAN_API_TOKEN

asdasdsadasfdfhgfsdgsdfdasgfhfhfuytrefdgsdfg
```
With this we complete the commands that give circleCI permission to converse with DigitalOcean

Now we need that in each deploy the machines are replaced with our new snapshots, we will use jq to use the digitalocean apis and get the name of my image created with packager.io

```
export TF_VAR_image_id = curl -H "Authorization: Bearer $DIGITALOCEAN_API_TOKEN" https://api.digitalocean.com/v2/images?private=true |jq . "images[] | select(.name == \"devops-demo-snapshot-$CIRCLE_BUILD_NUM\" |.id)"
```

To make deployments in Terraform and first create the machines and then destroy the previous ones in that order is used lifecycle block, which in terrfarom is create_before_destroy

So that CircleCI can pushear terraform changes we need to create an ssh key in github and add it in circleCI in SSH Permisions.

We will use [skip ci] in the commit to avoid the deployment loops




